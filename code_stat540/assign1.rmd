Assignment 1
========================================================

Wen Si (Sibyl) Gao

### Intro ###

This analysis is based on publicly-available expression study of mouse brain tissue with single gene mutation (http://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE7191). 

S1P2, when mutated, results in seizures. While mutated S1P3, a related gene, does not. In this study, gene expression of two brain regions (hippocampus and neocortex) from three mouse strains (wild type, S1P2 mutant, and S1P3 mutant) are measured. Additional information of gender of the mice and processing date is available in the data being analyzed.

Expression is measured on the Affymetrix MGU74Av2 platform.
```{r}
library(plyr)
library(ggplot2)
library(xtable)
library(RColorBrewer)
library(gplots)
library(preprocessCore)
library(reshape)
```

```{r include = FALSE}
library(knitr)
opts_chunk$set(tidy = FALSE, 
               comment=NA,
               digits = 3)
```

```{r include = FALSE}
html_print <- function(x, ..., digits = 0, include.rownames = TRUE){
  print(xtable(x, digits = digits, ...), 
        type = 'html', include.rownames = include.rownames)
}
```

```{r}
design <- read.table("../data/mouseBrain/GSE7191-design.txt",
                     row.names=1, header=TRUE)
expDat <- read.table("../data/mouseBrain/GSE7191-data.txt",
                     row.name="probe", header=TRUE)
design$Sid <- rownames(design)

# order expression data columns (samples) by the rows in the design table
expDat <- expDat[, row.names(design)]
```

```{r}
# create new factor for DateRun
# levels are order by increasing date, and labeled by "Day-1", etc
newDateRun <- with(design, {
  dates <- as.Date(levels(design$DateRun),"%m/%d/%y")
  nfDateRun <- factor(DateRun, levels(DateRun)[order(dates)])
  levels(nfDateRun) <- paste("Day", 1:nlevels(DateRun), sep="-") 
  return(nfDateRun)
})
design$DateRun <- newDateRun

# more informative column names for expDat
colnames(expDat) <- 
  with(design, paste(DateRun, 
                     substr(Genotype,1,4), 
                     substr(BrainRegion,1,4), 
                     substr(Sex,1,1), Sid,
                     sep="_"))

# define sample order
sampleOrd <- with(design, order(DateRun, Genotype, BrainRegion, Sex))
expDat <- expDat[,sampleOrd]
design <- design[sampleOrd,]

```


### Q1) Basic Characteristics ###

#### a) Dimensionality of the data
```{r}
dim(expDat)  # [probes, samples]
dim(design)  # [samples, design factors]
fa <- colnames(design) # design factors
```


#### b) Factors in experimental design

Looking at each factor individually, samples are mostly evenly distributed across different levels of a factor. The exception is that there is smaller sample size for S1P3 knockout group.

```{r}
with(design, table(Genotype))
with(design, table(BrainRegion))
with(design, table(Sex))
with(design, table(DateRun))

```

```{r include=FALSE, results='asis'}

faCounts <- ldply(design, function(x){
  faFeq <- table(x)
  iFaCounts <- data.frame(faFeq)
  colnames(iFaCounts) <- c("factor.level", "counts")
  return(iFaCounts)
})
html_print(faCounts)
```


Cross-tabulating genotype and brain region also finds no issue with the factorial experimental design. As sample sizes are relatively even across all genotype-brain region cobminations (besides the issue of fewer S1P3 knockouts):

```{r results='asis'}
x <- with(design, table(BrainRegion, Genotype))
html_print(addmargins(x))
```

Even as the gender of the mouse is taken into account. The design seem okay:
```{r}
x <- with(design, table(Sex, BrainRegion, Genotype))
ftable(x)
```


Problem seem to appear when examining DateRun as a factor. DateRun could potentially confound both Genotype and gender of the mouse. It is often the case that a single day contains only samples of the same genotype and samples of the same gender. As a result, one may not know if different expression readings is due to different genotypes, or different dates the sample is run. It's the same case with gender of the mouse. If DateRun (the batch effect) is an important factor of the expression readings, one has to correct for this effect. 

```{r}
x <- with(design, table(Genotype, DateRun))
ftable(x)
x <- with(design, table(Genotype, DateRun))
ftable(x)
```


#### c) Explore differenitial readings on one probe

I decided to examining the readings of the probe for S1P2 (S1pr2). The probe for S1P2 is 99372_at on this platform.

```{r fig.width=10, fig.height=4}
(theProbe <- which(row.names(expDat) == '99372_at'))
pDat <- data.frame(design, gExp = unlist(expDat[theProbe, ]))

ggplot(pDat, aes(x=Genotype, y=gExp, color=BrainRegion)) + geom_point(alpha=0.6) + facet_grid(.~Sex)
```

Clearly something isn't right here. The probe reading of S1P2 in the S1P2 knockout group is supposed to decrease, yet the reading is the same or even higher there than that in the wildtype. 

#### d) Differential readings on one probe (numeric)

```{r}
# compute mean expression at each combination of Genetype, BrainRegion and Sex
pMean <- aggregate(gExp ~ Genotype + BrainRegion + Sex, pDat, FUN = mean)

# display the result in wide form
x <- xtabs(gExp~BrainRegion+Sex+Genotype,pMean)
ftable(x)
```



### Q2 Examine the sample correlation matrix

#### a)

```{r}
# creating some color palette
jPurplesFun <- colorRampPalette(brewer.pal(n = 9, "Purples"))
jGreysFun <- colorRampPalette(brewer.pal(n = 9, "Greys"))
```

```{r fig.width=10, fig.height=10}
sampleCor <- cor(expDat)

myheatmap <- function(sampleCor, ...){
  heatmap.2(sampleCor, 
            Rowv = FALSE, dendrogram="none",
            symm=TRUE, margins=c(15,15),
            trace="none", scale="none", col = jGreysFun(256))
}
myheatmap(sampleCor)
```


b) Outlier sample

To show how the outlier stands out visually, I computed the mean correlation for each row. And display the distribution of the means using a density plot.
```{r}
meanCor <- rowMeans(sampleCor)
ggplot(data.frame(meanCor=meanCor),
       aes(x=meanCor)) +
  geom_bar(alpha=0.5)

(outlierName <- names(which(meanCor==min(meanCor))))
```

Numerically, I computed the rank sum test to show that the correlation involving outlier sample has a different mean from those not involving the outlier sample. I suppose I have to assume independence between all these correlation coefficeints which obviously isn't true, but maybe I can be sloppy here... 
```{r}
```



### 3  Normalization 

#### a) Prior to normalization

```{r}
# elongate <- function(hDat){
#   sampleName <- factor(colnames(eDat))
#   ldply(hDat, summarize){
# #     print(dim(x))
# #     print(names(x))
# #     return(data.frame(gExp=x, sampleName=x))
#   })
# }
```

```{r}
set.seed(540)
hSize <- 2000
theseProbes <- sample(1:nrow(expDat), hSize)
expDat2 <- expDat[theseProbes,]
expDat2 <- expDat

longExpDat <- melt(cbind(expDat2, probe=rownames(expDat2)), 
                   'probe')
longExpDat <- rename(longExpDat, 
                     c("variable"="SampleName", "value"="gExp"))



p <- ggplot(longExpDat, 
            aes(SampleName, gExp, color=SampleName==outlierName))
p + geom_boxplot()
```


```{r}

myNormalize <- function(eDat){
  neDat <- normalize.quantiles(as.matrix(eDat))
  neDat <- data.frame(neDat)
  rownames(neDat) <- rownames(eDat)
  colnames(neDat) <- colnames(eDat) 
  return(neDat)
}

nExpDat <- myNormalize(expDat)

```


#### b) With normalization alone
```{r}
myheatmap(cor(nExpDat))
```


#### c) With outlier removed and quantile normalization
```{r}
nrExpDat <- expDat[, colnames(expDat) != outlierName]
nrExpDat <- myNormalize(nrExpDat)
myheatmap(cor(nrExpDat))
```


```{r}
#heatmap(expDat, Rowv = NA, Colv = NA, scale="none", margins = c(5, 8), col = jBuPuFun(256))
# set.seed(540)
# hSize <- 200
# theseProbes <- sample(1:nrow(expDat), hSize)
# hDat <- expDat[theseProbes, sampleOrd]
# hDat <- as.matrix(hDat)
# colnames(hDat) <- with(design[sampleOrd,],
#                        paste(DateRun, Genotype, BrainRegion, Sex, sep="_"))
# 
# 
# jPurplesFun <- colorRampPalette(brewer.pal(n = 9, "Purples"))
# heatmap(hDat, Colv = NA, Rowv = NA, scale=c("column"), 
#         margins = c(5, 8), col = jPurplesFun(256))
```


```{r fig.width=7, fig.height=6}
plot(cars)
```

